# tools/search.py 文件分析

`InsightEngine/tools/search.py` 文件定义了 `MediaCrawlerDB` 类，这是一个专为 AI Agent 设计的本地舆情数据库查询工具集。它的核心业务逻辑是**将复杂的、底层数据库查询操作封装成一系列高层级的、语义化的工具函数，供 `DeepSearchAgent` 调用，从而实现对舆情数据的检索、分析和聚合**。

### 1. **核心定位：本地舆情数据库的智能访问层**

-   `MediaCrawlerDB` 并不直接爬取数据，而是作为 `DeepSearchAgent` 的主要数据源，假设数据已经存在于本地的 MySQL 数据库中（通过 `utils.db` 模块进行连接）。
-   它将复杂的 SQL 查询逻辑抽象为一系列易于理解和调用的 Python 方法。`DeepSearchAgent` 只需根据其研究意图选择合适的工具，而无需关心具体的数据库表结构和复杂的 SQL 查询语法。这极大地简化了 Agent 对数据的访问。

### 2. **数据结构定义 (`QueryResult`, `DBResponse`)**

-   **`QueryResult`**：这是一个 `dataclass`，用于统一表示从数据库中获取的单条内容（无论是视频、笔记、评论还是新闻）。它标准化了从不同平台和内容类型中提取的关键信息，包括 `platform`（平台）、`content_type`（内容类型）、`title_or_content`（标题或内容主体）、`author_nickname`（作者昵称）、`url`（内容链接）、`publish_time`（发布时间）、`engagement`（互动数据，如点赞、评论、分享等）、`hotness_score`（热度分数）和 `source_keyword`（原始来源关键词）。
-   **`DBResponse`**：这是一个 `dataclass`，用于封装单个工具调用的完整响应。它包含被调用的 `tool_name`（工具名称）、传入的 `parameters`（参数）、`QueryResult` 对象的列表 (`results`)、`results_count`（结果数量）和可能的 `error_message`。这为 `DeepSearchAgent` 提供了清晰、结构化的工具执行反馈，方便其进行后续的判断和处理。

### 3. **核心内部机制**

-   **`_execute_query`**：私有方法，负责与 `utils.db` 模块进行交互，执行实际的异步 SQL 查询。它处理了 `asyncio` 事件循环的创建和管理，确保数据库操作能够正确执行，并返回查询结果。
-   **`_to_datetime`**：静态方法，功能强大且健壮。它能够将数据库中各种格式的时间戳（字符串、整数、浮点数、`datetime` 对象或 `date` 对象）统一转换为 Python 的 `datetime` 对象，确保时间数据处理的一致性，避免了因数据格式不统一导致的问题。
-   **`_get_table_columns`**：私有方法，用于查询并缓存数据库表的列信息。通过缓存，可以减少重复的数据库元数据查询，提高效率。
-   **`_extract_engagement`**：私有方法，从数据库的原始数据行中提取并标准化各种平台特有的互动指标（如 `liked_count`, `comments_count`, `video_share_count` 等），将其映射到统一的 `likes`, `comments`, `shares`, `views` 等字段，这对于后续的综合热度计算和情感分析至关重要。
-   **热度计算公式 (`W_LIKE`, `W_COMMENT` 等)**：类中定义了一组权重，用于对不同互动指标进行加权。例如，`W_SHARE` 的权重高于 `W_LIKE`，反映了分享行为在社交媒体中通常具有更高的传播价值。这些权重是计算内容综合热度分数的核心算法组成部分。

### 4. **主要工具函数 (供 AI Agent 调用)**

`MediaCrawlerDB` 封装了一系列针对舆情分析场景定制的、目标明确的工具函数，`DeepSearchAgent` 通过调用这些函数来获取所需数据。

-   **`search_hot_content` (查找热点内容)**：
    -   **目的**：获取在指定时间范围内（24小时、一周、一年）综合热度最高的内容。
    -   **机制**：该工具不依赖于外部排序参数，而是内部通过预设的加权算法（利用 `W_` 系列权重和复杂的 SQL 表达式）计算每个内容的 `hotness_score`。然后，它通过 `UNION ALL` 组合多个平台的内容表，并按计算出的热度分数降序排序，返回最热门的结果。
    -   **业务价值**：直接响应 Agent 对“什么是热门”的需求，提供一个统一、智能的热度衡量标准，帮助 Agent 快速识别当前舆情焦点。

-   **`search_topic_globally` (全局话题搜索)**：
    -   **目的**：在所有内容表和评论表中，全局搜索与特定话题关键词相关的所有内容。
    -   **机制**：它会遍历所有预设的内容表和评论表，在多个关键字段（标题、描述、内容、标签、来源关键词等）中进行模糊匹配 (`LIKE %topic%`)。最终将所有匹配的结果进行聚合。
    -   **业务价值**：提供了一个全面的、无偏见的广度搜索能力，帮助 Agent 了解一个话题在整个舆情数据库中的分布和讨论情况。

-   **`search_topic_by_date` (按日期搜索话题)**：
    -   **目的**：在明确指定的历史日期范围内，搜索与特定话题相关的内容。
    -   **机制**：与全局搜索类似，但增加了对 `start_date` 和 `end_date` 参数的严格日期验证和时间范围过滤。它能够智能处理不同平台时间戳存储格式的差异（如秒级时间戳、毫秒级时间戳、字符串日期等），确保跨平台日期筛选的准确性。
    -   **业务价值**：允许 Agent 进行时间线分析，追踪话题在特定时间段内的热度变化和讨论详情，对于事件发展脉络分析至关重要。

-   **`get_comments_for_topic` (获取话题评论)**：
    -   **目的**：专门搜索并返回所有平台中与特定话题相关的公众评论数据。
    -   **机制**：它会专门查询所有预设的评论表（如 `bilibili_video_comment`, `weibo_note_comment` 等），在 `content` 字段中进行模糊匹配，并聚合评论内容、作者、发布时间、点赞数等信息。
    -   **业务价值**：直接深入到用户最真实的“声音”层面，对于进行细致的情感分析和观点挖掘至关重要。

-   **`search_topic_on_platform` (平台定向搜索)**：
    -   **目的**：在一个指定的**单一**社交媒体平台上搜索特定话题，并支持时间范围筛选。
    -   **机制**：这个工具是 `search_topic_by_date` 和 `search_topic_globally` 的平台限定版本。它会根据 `platform` 参数，只查询该平台下的内容表和评论表，并支持 `start_date` 和 `end_date` 进行时间筛选。
    -   **业务价值**：满足 Agent 对特定平台用户群体特征和讨论模式进行深入分析的需求，例如分析年轻人对某个话题在 Bilibili 上的独特表达。

### 总结

`InsightEngine/tools/search.py` 文件中的 `MediaCrawlerDB` 是 `DeepSearchAgent` 获取外部数据（此处是本地舆情数据库数据）的“感官系统”。它通过：

1.  **高度封装与抽象**：将复杂的数据库查询逻辑抽象为简洁、语义化的工具函数，使得上层 Agent 无需具备 SQL 知识，能够专注于更高层次的推理。
2.  **统一的数据模型**：`QueryResult` 和 `DBResponse` 确保了从不同表和工具获取的数据都具有一致的结构，便于 Agent 进行统一处理和分析。
3.  **智能热度计算**：内置的加权算法能够为 Agent 提供一个更符合综合舆情热度的衡量标准，而非简单的点赞数。
4.  **多维度检索能力**：提供多种细分工具（全局、按日期、按平台、评论等），满足 Agent 在不同研究阶段对数据深度和广度的差异化需求。

这个工具集是 `DeepSearchAgent` 能够有效地收集、筛选和组织其所需信息的关键基础设施，是其执行深度舆情分析任务的基石。
