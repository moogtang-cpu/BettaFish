# prompts/prompts.py 文件分析

`InsightEngine/prompts/prompts.py` 文件是 `DeepSearchAgent` 的“大脑”和“指令中心”。它集中定义了在整个研究工作流中，与大语言模型（LLM）进行交互所需的所有系统提示词（`SYSTEM_PROMPT_*`）以及数据交换的 JSON Schema 定义（`output_schema_*`，`input_schema_*`）。

### 业务逻辑分析

这个文件的核心业务逻辑在于**通过精心设计的提示词和结构化数据定义，精确地指导 LLM 在 `DeepSearchAgent` 的各个阶段执行特定任务，并确保其输出符合预期的数据格式。** 它是将 LLM 的通用智能转化为 `DeepSearchAgent` 特定领域专业能力的关键。

#### 1. JSON Schema 定义

-   **目的**：为 `DeepSearchAgent` 中的各个节点与 LLM 之间的数据交换定义严格的 JSON 结构。这对于确保 LLM 能够生成可解析的、符合程序预期的数据格式至关重要，是实现 LLM 可靠集成的基础。这些 Schema 充当了 LLM 交互的“数据契约”。
-   **覆盖范围**：文件中定义了从报告结构生成到最终报告格式化的每一个核心步骤的输入和输出 JSON 模式。例如：
    -   `output_schema_report_structure`：规定了报告结构节点应返回的段落列表格式。
    -   `output_schema_first_search` / `output_schema_reflection`：除了搜索查询和推理，还详细定义了 `search_tool`、`start_date`、`end_date`、`platform` 等工具调用所需的参数。这使得 LLM 不仅生成查询，还能智能地选择和配置搜索工具。
    -   `output_schema_first_summary` / `output_schema_reflection_summary`：定义了总结节点应返回的总结内容格式。
    -   `input_schema_report_formatting`：定义了报告格式化节点期望接收的所有段落最终内容列表。
-   **业务价值**：这些 JSON Schema 清晰地告诉 LLM 应该以什么样的数据结构来返回结果，从而大大简化了后端对 LLM 输出的解析和验证过程，减少了错误，是系统稳定运行的关键保障。

#### 2. 系统提示词定义

-   **目的**：每个 `SYSTEM_PROMPT_*` 都是一个详细的、多轮对话式的指令集合。它为 LLM 在 `DeepSearchAgent` 的特定节点中设定了其**角色、任务目标、行为准则、输出要求、关键示例和注意事项**。这些提示词是 `DeepSearchAgent` 智能行为的真正来源和其“专业素养”的体现。
-   **详细分析**：

    -   **`SYSTEM_PROMPT_REPORT_STRUCTURE` (报告结构)**：
        -   **角色**：专业的舆情分析师和报告架构师。
        -   **任务**：根据用户查询，规划一个全面、深入的舆情分析报告结构。
        -   **核心指令**：明确要求 5 个核心段落，强调从宏观到微观、现象到本质的逻辑递进分析，并确保涵盖情感、平台、时间、群体、深层原因等多个维度。特别要求每个段落的 `content` 字段详细描述分析点、数据类型等，以指导后续研究。
        -   **业务价值**：作为整个研究的宏观规划指令，它引导 LLM 将一个复杂的研究主题分解为一系列可执行的子任务，为 `DeepSearchAgent` 的后续工作提供了清晰的路线图。

    -   **`SYSTEM_PROMPT_FIRST_SEARCH` (首次搜索)**：
        -   **角色**：专业的舆情分析师。
        -   **任务**：根据给定段落的需求，生成最佳的数据库搜索查询，并选择合适的工具。
        -   **核心指令**：
            -   **工具选择**: 详细列举了 6 种可用的本地舆情数据库查询工具，并说明了它们的适用场景、特点和参数。这是 LLM 进行工具选择的核心依据。
            -   **“接地气”搜索词设计 (最关键)**：**明确强调避免官方术语，鼓励使用网民的真实表达、贴近生活的语言、情感词汇和话题热词。** 提供了正反例和不同平台语言特色参考，以及情感表达词汇库。这确保了搜索能最大化地捕获真实的民意和情感，是 `InsightEngine` 区别于传统搜索引擎的关键亮点。
            -   **参数优化**：指导 LLM 如何正确配置工具的特殊参数（如日期、平台）。
        -   **业务价值**：将高层级的段落研究需求，转化为具体、可执行的数据库查询。其对“人情味”搜索词的强调，是确保获取真实民意数据的核心。

    -   **`SYSTEM_PROMPT_FIRST_SUMMARY` (首次总结)**：
        -   **角色**：专业的舆情分析师和深度内容创作专家。
        -   **任务**：将原始社交媒体数据转化为深度、全面的舆情分析段落。
        -   **核心指令**：要求每段不少于 800-1200 字，强调**大量引用原始数据（用户评论）、精确数据统计、详细情感分析数据和平台数据对比**。提供了结构化内容组织示例和多层次深度分析要求。
        -   **业务价值**：这是 `DeepSearchAgent` 撰写报告内容的具体指导。它确保了生成的报告不仅仅是数据堆砌，而是经过深度分析和结构化呈现的高质量内容。

    -   **`SYSTEM_PROMPT_REFLECTION` (反思)**：
        -   **角色**：资深的舆情分析师。
        -   **任务**：深化舆情报告内容，使其更贴近真实的民意和社会情感。
        -   **核心指令**：引导 LLM 自我批判，检查现有内容是否过于官方、缺乏真实声音、遗漏重点或需要补充具体案例。明确指出需要补充哪些平台、时间段或具体民意表达。再次强调“接地气”搜索关键词的设计，重点关注评论区和用户原创内容。
        -   **业务价值**：这是 `DeepSearchAgent` 迭代优化和自我完善的核心驱动力。它使得代理能够识别自身不足，并主动寻求弥补信息差距，从而不断提升报告的深度和真实性。

    -   **`SYSTEM_PROMPT_REFLECTION_SUMMARY` (总结反思)**：
        -   **角色**：资深的舆情分析师和内容深化专家。
        -   **任务**：对已有报告段落进行深度优化和内容扩充，使其更加全面、深入、有说服力。
        -   **核心指令**：要求保留原有精华，但需要**大量补充**新的数据点、用户声音和分析层次，目标是每段 1000-1500 字。强调数据密集化处理、结构化内容组织、多维度深化分析和严格的质量提升标准。
        -   **业务价值**：这是 `DeepSearchAgent` 在反思循环中对报告内容进行实际修订和扩充的指导。它确保了迭代过程能够真正地提升报告的质量和丰富度。

    -   **`SYSTEM_PROMPT_REPORT_FORMATTING` (最终报告格式化)**：
        -   **角色**：资深的舆情分析专家和报告编撰大师。
        -   **任务**：将复杂的民意数据转化为深度洞察的专业舆情分析报告，目标是**不少于一万字**。
        -   **核心指令**：提供了非常详细和专业的 Markdown 报告架构模板（包括执行摘要、各段落详情、舆情态势综合分析、深层洞察与建议以及数据附录），甚至包含了表格示例。强调情感可视化、民意声音突出、数据故事化、社会洞察深度和专业舆情术语的使用。
        -   **业务价值**：这是整个研究流程的最终呈现环节。它确保了 `DeepSearchAgent` 产出的报告不仅内容深度足够，而且在格式和表达上都达到了专业的、引人入胜的水平，能够有效传达其深度洞察。

### 总结

`InsightEngine/prompts/prompts.py` 是 `DeepSearchAgent` 的“灵魂”所在。它通过：

1.  **结构化数据契约 (JSON Schema)**：确保了 LLM 交互的数据输入输出的稳定性和可预测性，是系统稳定性的重要保障。
2.  **精细化角色设定和任务指令 (System Prompts)**：赋予了 LLM 在每个阶段具体的、高度专业的“人格”和“任务清单”。这些提示词不仅仅是简单的指令，它们包含了丰富的领域知识、写作要求、分析方法和质量标准，是 `DeepSearchAgent` 能够执行复杂研究任务的根本。特别是对“人情味”和“真实民意”的强调，是其核心竞争力。

这个文件的高度精细化和专业化的提示词设计，是 `InsightEngine` 能够从原始数据中提取深度洞察并生成高质量报告的关键因素。它将 LLM 的通用能力，通过专业的指导，转化为一个特定领域（舆情分析）的专家系统。
