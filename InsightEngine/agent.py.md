# agent.py 业务逻辑分析

`agent.py` 文件定义了 `InsightEngine` 的核心控制器——`DeepSearchAgent` 类。这个 Agent 的设计目标是模拟一位专业研究员的工作流程，对给定的查询进行深入、全面、结构化的研究，并最终生成一份高质量的分析报告。

### 1. **核心定位：自动化研究与报告生成器**

`DeepSearchAgent` 的主要职责是执行一个复杂的、端到端的自动化研究任务。它整合了 `InsightEngine` 内部的各种组件（LLM、工具、节点），通过一个精心设计的流程来完成从接收用户查询到产出最终报告的全过程。

### 2. **初始化 (`__init__`)**

在创建 `DeepSearchAgent` 实例时，它会进行一系列初始化操作：
- **加载配置**: 读取 `Settings` 对象，确定 Agent 的行为参数（如 API 密钥、模型名称、最大反思次数等）。
- **初始化 LLM 客户端**: 创建一个 `LLMClient` 实例，用于与大语言模型进行通信。
- **加载工具集**:
    - `MediaCrawlerDB`: 初始化一个数据库搜索工具，用于在本地知识库中查找信息。
    - `multilingual_sentiment_analyzer`: 初始化一个多语言情感分析工具，用于评估文本的情感倾向。
- **初始化节点 (Nodes)**: 实例化一系列代表不同工作步骤的“节点”对象，例如 `FirstSearchNode`（首次搜索节点）、`ReflectionNode`（反思节点）等。这些节点是构成其工作流的基本单元。
- **创建状态机**: 创建一个 `State` 对象，这个对象非常关键，它将贯穿整个研究过程，用于记录和管理任务的所有中间状态和数据。

### 3. **核心工作流：`research` 方法**

`research` 方法是 Agent 执行任务的入口，其内部实现了一个严谨的多阶段研究流程：

**阶段一：规划报告结构 (`_generate_report_structure`)**
- **目的**: 谋定而后动。
- **流程**: 接收到用户的初始查询后，Agent 首先调用 `ReportStructureNode` 节点。该节点会请求 LLM 根据查询内容，生成一个逻辑清晰的报告大纲（包含多个段落标题和简介）。这相当于为整个研究工作制定了一个详细的计划。

**阶段二：分段深度研究 (`_process_paragraphs`)**
- **目的**: 逐个击破，深度挖掘。
- **流程**: Agent 会遍历第一阶段生成的所有段落标题，并对每一个段落执行一个独立的“搜索-总结-反思”子循环。

    1.  **首次搜索与总结 (`_initial_search_and_summary`)**:
        - **生成查询**: 调用 `FirstSearchNode`，让 LLM 根据段落标题生成具体的、适合数据库搜索的关键词和查询策略（例如，是全局搜索还是按日期搜索）。
        - **关键词优化**: 在执行搜索前，它会调用 `keyword_optimizer` 工具。这个工具会利用 LLM 对原始搜索词进行优化和扩展，生成一组更有效、覆盖面更广的关键词，极大地提升了信息检索的召回率。
        - **执行搜索**: 使用优化后的关键词，通过 `MediaCrawlerDB` 工具在数据库中进行搜索。
        - **情感分析 (可选)**: 搜索到的结果可以自动送入情感分析工具，为数据增加情感维度的洞察。
        - **生成初稿**: 将搜索结果和情感分析数据喂给 `FirstSummaryNode`，让 LLM 为这个段落生成第一版的内容摘要。

    2.  **反思与迭代 (`_reflection_loop`)**: 这是实现“深度”研究的关键。
        - **自我批判**: Agent 会调用 `ReflectionNode`，让 LLM “阅读”刚刚生成的第一版摘要，并提出批判性问题，例如：“这份摘要还缺少哪些信息？”或“哪些观点需要更多证据支撑？”。
        - **生成新查询**: 基于这些批判性问题，LLM 会生成新一轮的、更有针对性的搜索查询。
        - **再次搜索与总结**: Agent 会用这些新查询重复之前的搜索和总结步骤。
        - **循环精炼**: 这个“反思-搜索-更新摘要”的过程会重复进行多次（次数由配置中的 `MAX_REFLECTIONS` 决定）。通过这种方式，段落内容被不断地补充、修正和深化。

**阶段三：整合与生成最终报告 (`_generate_final_report`)**
- **目的**: 汇总成果，形成报告。
- **流程**: 当所有段落都经过了深度研究后，Agent 会将所有段落的最终版摘要收集起来，然后调用 `ReportFormattingNode`。这个节点负责将这些零散的段落内容整合成一篇结构完整、语言流畅、格式优美的最终报告。

**阶段四：保存成果 (`_save_report`)**
- **目的**: 持久化输出。
- **流程**: 将生成的最终报告保存为一个 Markdown 文件。同时，根据配置，还可以将整个研究过程的 `State` 对象序列化为 JSON 文件保存下来，这对于调试、分析 Agent 行为或未来实现任务断点续传非常有价值。

### 总结

`DeepSearchAgent` 的业务逻辑是对人类专家研究过程的高度模拟和自动化。它通过**“规划-执行-反思-迭代”**的核心循环，将一个模糊的初始查询，逐步转化为一个具体、深入、有据可查的研究报告。它不是一次性的简单搜索，而是一个动态的、自我完善的知识发现过程，这使其能够产出远超传统搜索引擎的深度和广度的分析结果。
