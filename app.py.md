# app.py 业务逻辑分析

`app.py` 文件是整个 BettaFish 项目的核心，它扮演着一个中央控制台和后台管理服务器的角色。它基于 Flask 框架构建，主要负责管理、监控和协调项目中其他各个独立的功能模块（称为“引擎”）。

其核心业务逻辑可以分为以下几个部分：

### 1. **Web 服务器与前端界面**

- **Flask 应用**: 作为主程序入口，启动一个 Flask Web 服务器。
- **主页渲染**: 提供一个单页的前端界面（`templates/index.html`），用户可以通过这个界面与整个系统进行交互。
- **API 接口**: 定义了一系列 RESTful API 接口（路径以 `/api/` 开头），用于前端请求和后端处理。

### 2. **多引擎（子进程）管理**

- **统一管理**: 系统设计了三个核心的 Streamlit 应用：`Insight Engine`, `Media Engine`, 和 `Query Engine`。`app.py` 负责将这三个应用作为独立的子进程来启动、停止和监控。
- **状态监控**: 实时跟踪每个子应用的运行状态（如 `starting`, `running`, `stopped`）。前端可以通过 API (`/api/status`) 获取这些状态，从而在界面上展示每个引擎是否在正常工作。
- **日志系统**:
    - **实时日志**: 捕获每个 Streamlit 应用在运行过程中产生的标准输出和错误信息。
    - **日志存储**: 将捕获到的日志实时写入到 `logs/` 目录下的对应文件中（例如 `insight.log`）。
    - **实时推送**: 使用 `Socket.IO` 技术，将日志信息实时地推送到前端网页，让用户可以在控制台界面看到每个引擎的动态输出。

### 3. **ForumEngine 模块集成**

- **后台监控**: `ForumEngine` 是一个特殊的模块，它作为一个后台线程运行，负责监控一个名为 `forum.log` 的核心日志文件。
- **智能对话模拟**: `forum.log` 文件记录了其他几个引擎（`QUERY`, `INSIGHT`, `MEDIA`）之间的交互信息。`ForumEngine` 会实时读取这个文件的更新。
- **消息解析与推送**: 当 `forum.log` 有新内容时，`ForumEngine` 会解析出结构化的对话信息（如时间、来源、内容），并通过 `Socket.IO` 将这些消息推送到前端的“论坛”板块，模拟出一个多智能体（Agent）对话的实时场景。

### 4. **系统配置管理**

- **动态配置**: 提供 API 接口 (`/api/config`) 来读取和更新系统的核心配置项（如 API 密钥、数据库连接信息等）。
- **持久化存储**: 用户在前端修改的配置会通过后端写入到 `.env` 文件中，实现了配置的持久化。系统在重新加载后会读取新的配置。

### 5. **全局启动与关闭**

- **一键启动**: 提供一个“系统启动”的 API (`/api/system/start`)，该接口会按照预设的顺序初始化数据库、启动所有的 Streamlit 应用和 `ForumEngine` 监控。
- **安全退出**: 程序在退出时（通过 `atexit` 注册），会自动执行清理函数，确保所有由它启动的子进程都被安全地终止，避免产生僵尸进程。

### 6. **统一搜索接口**

- **请求分发**: 提供一个统一的搜索 API (`/api/search`)。当用户在前端发起搜索时，请求会首先到达 `app.py`。
- **任务下发**: `app.py` 会将这个搜索请求转发给当前所有正在运行的引擎（Insight, Media, Query），让它们各自执行搜索任务。这体现了其作为任务分发中心的角色。

### 总结

`app.py` 是一个“指挥中心”，它本身不直接处理核心的数据分析业务，而是通过一个现代化的 Web 界面，为用户提供了一个简单、直观的方式来统一管理和编排整个 BettaFish 系统。用户无需通过命令行手动操作，即可完成所有模块的启停、状态监控、日志查看和配置修改，大大提升了系统的易用性和可维护性。
